@extends('admin/layouts/contentLayoutMaster')

@section('title', __('vulnerability.VulnerabilityManagement'))

@section('vendor-style')
    <link rel="stylesheet" href="{{ asset('fonts/fontawesome-6.2.1/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ asset(mix('vendors/css/extensions/toastr.min.css')) }}">
    <link rel="stylesheet" href="{{ asset(mix('vendors/css/tables/datatable/dataTables.bootstrap5.min.css')) }}">
    <link rel="stylesheet" href="{{ asset(mix('vendors/css/tables/datatable/responsive.bootstrap5.min.css')) }}">

    <link rel="stylesheet" href="{{ asset(mix('vendors/css/tables/datatable/buttons.bootstrap5.min.css')) }}">
    <link rel="stylesheet" href="{{ asset(mix('vendors/css/forms/select/select2.min.css')) }}">
    <link rel="stylesheet" href="{{ asset(mix('vendors/css/animate/animate.min.css')) }}">
    <link rel="stylesheet" href="{{ asset(mix('vendors/css/extensions/sweetalert2.min.css')) }}">
    <link rel="stylesheet" href="{{ asset(mix('vendors/css/pickers/flatpickr/flatpickr.min.css')) }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('css/base/plugins/forms/pickers/form-flat-pickr.css') }}">
    <link rel="stylesheet" href="{{ asset(mix('css/base/plugins/forms/pickers/form-flat-pickr.css')) }}">
@endsection

@section('page-style')
    <link rel="stylesheet" href="{{ asset(mix('css/base/plugins/extensions/ext-component-toastr.css')) }}">
    <link rel="stylesheet" href="{{ asset(mix('css/base/plugins/extensions/ext-component-sweet-alerts.css')) }}">
@endsection
@section('content')

    <!-- Advanced Search -->
    <x-vulnerability-management-info-search id="advanced-search-datatable" :assets="$assets" :teams="$teams"
        :regions="$regions" createModalID="add-new-vulnerability-management" />
    <!--/ Advanced Search -->

<!-- Create Form -->
@if (auth()->user()->hasPermission('vulnerability_management.create'))
    <x-vulnerability-management-info-form 
        id="add-new-vulnerability-management"
        :assets="$assets"
        :teams="$teams"
        :ips="$ips"
        title="{{ __('vulnerability.AddANewVulnerability') }}" />
@endif
<!--/ Create Form -->

<!-- Update Form -->
@if (auth()->user()->hasPermission('vulnerability_management.update'))
    <x-vulnerability-management-info-form 
        id="edit-vulnerability-management"
        :assets="$assets"
        :teams="$teams"
        :ips="$ips"
        title="{{ __('vulnerability.EditVulnerability') }}" />
@endif
<!--/ Update Form -->


@endsection

@section('vendor-script')
    <script src="{{ asset(mix('vendors/js/tables/datatable/jquery.dataTables.min.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/tables/datatable/dataTables.bootstrap5.min.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/tables/datatable/dataTables.responsive.min.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/tables/datatable/responsive.bootstrap5.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/tables/datatable/buttons.print.min.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/tables/datatable/datatables.buttons.min.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/forms/select/select2.full.min.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/extensions/sweetalert2.all.min.js')) }}"></script>
    <script src="{{ asset(mix('vendors/js/pickers/flatpickr/flatpickr.min.js')) }}"></script>
@endsection


@section('page-script')
    {{-- <script src="{{ asset(mix('js/scripts/forms/form-select2.js')) }}"></script> --}}
    <script src="{{ asset(mix('vendors/js/extensions/toastr.min.js')) }}"></script>
    <script>
        permission = [];
        permission['edit'] = {{ auth()->user()->hasPermission('vulnerability_management.update') ? 1 : 0 }};
        permission['delete'] = {{ auth()->user()->hasPermission('vulnerability_management.delete') ? 1 : 0 }};

        const lang = []
        URLs = [];

        URLs['ajax_list'] = "{{ route('admin.vulnerability_management.ajax.indexInfo') }}";
        URLs['update'] = "{{ route('admin.vulnerability_management.ajax.updateInfo', ':id') }}";
        URLs['delete'] = "{{ route('admin.vulnerability_management.ajax.destroyInfo', ':id') }}";
        URLs['edit'] = "{{ route('admin.vulnerability_management.ajax.editInfo', ':id') }}";
        URLs['get_ip_assets'] = "{{ route('admin.vulnerability_management.ajax.getIpAssets') }}";

        lang['user'] = "{{ __('locale.User') }}";
        lang['confirmDelete'] = "{{ __('locale.ConfirmDelete') }}";
        lang['cancel'] = "{{ __('locale.Cancel') }}";
        lang['success'] = "{{ __('locale.Success') }}";
        lang['error'] = "{{ __('locale.Error') }}";
        lang['confirmDeleteFileMessage'] = "{{ __('locale.AreYouSureToDeleteThisFile') }}";
        lang['confirmDeleteRecordMessage'] = "{{ __('locale.AreYouSureToDeleteThisRecord') }}";
        lang['revert'] = "{{ __('locale.YouWontBeAbleToRevertThis') }}";
        lang['Open'] = "{{ __('locale.Open') }}";
        lang['Closed'] = "{{ __('locale.Closed') }}";
        lang['In Progress'] = "{{ __('locale.In Progress') }}";
        lang['Overdue'] = "{{ __('locale.Overdue') }}";
        lang['Critical'] = "{{ __('locale.Critical') }}";
        lang['High'] = "{{ __('locale.High') }}";
        lang['Medium'] = "{{ __('locale.Medium') }}";
        lang['Low'] = "{{ __('locale.Low') }}";
        lang['Informational'] = "{{ __('locale.Informational') }}";
        lang['DetailsOfItem'] =
            "{{ __('locale.DetailsOfItem', ['item' => __('vulnerability.VulnerabilityManagement')]) }}";
        lang['selectOption'] = "{{ __('locale.select-option') }}";
    </script>

    <script src="{{ asset('ajax-files/vulnerability_management/indexInfo.js') }}"></script>
    <script>
        $(document).ready(function() {
            $('#export-vulns-btn').on('click', function() {
                var region = $('#exportRegion').val();
                var severity = $('#exportSeverity').val();
                var tenable_status = $('#exportTenableStatus').val();
                $.ajax({
                    url: '{{ route('admin.vulnerability_management.ajax.export') }}',
                    method: 'POST',
                    data: {
                        _token: '{{ csrf_token() }}',
                        type: 'xlsx', // or 'pdf' based on the requirement
                        tenable_status: tenable_status,
                        severity: severity,
                        region: region
                    },
                    success: function(response) {
                        makeAlert('success', response.message, "{{ __('locale.Success') }}");
                        $('#exportVulnModal').modal('hide');
                    },
                    error: function(xhr) {
                        makeAlert('error', 'An error occurred while exporting vulns.');
                    }
                });
            });
        });

        function makeAlert($status, message, title) {
            // On load Toast
            if (title == 'Success')
                title = 'ðŸ‘‹' + title;
            toastr[$status](message, title, {
                closeButton: true,
                tapToDismiss: false,
            });
        }
    </script>
    <script>
        $(document).ready(function() {
            $('#controlNotificationVulnModal').on('show.bs.modal', function() {
                // Make an AJAX call to fetch the data
                $.ajax({
                    url: '{{ route('admin.vulnerability_management.vulnerabilitiesSendNotification.getFirstRecord') }}', // Your route to fetch data
                    type: 'GET',
                    success: function(response) {
                        // Check if the record exists
                        if (response.data) {
                            // Fill the modal fields with the data
                            $('select[name="status"]').val(response.data.status);
                            $('select[name="vuln_asset_region"]').val(response.data
                                .vuln_asset_region);
                            $('select[name="severity"]').val(response.data.severity);
                            $('select[name="exploit"]').val(response.data.exploit);
                            $('input[name="first_discovered"]').val(response.data
                                .first_discovered);
                            $('input[name="last_discovered"]').val(response.data
                                .last_discovered);
                        } else {
                            // Clear the modal fields if no data exists
                            $('#controlNotificationVulnForm')[0].reset();
                        }
                    },
                    error: function() {
                        alert('Error fetching data.');
                    }
                });
            });
        });


        $(document).ready(function() {
            // Initialize Flatpickr for first and last discovered fields
            var firstDiscovered = flatpickr("#first_discovered", {
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr) {
                    // Update minDate of last_discovered based on first_discovered
                    lastDiscovered.set('minDate', dateStr);
                }
            });

            var lastDiscovered = flatpickr("#last_discovered", {
                dateFormat: "Y-m-d",
                onChange: function(selectedDates, dateStr) {
                    // Update maxDate of first_discovered based on last_discovered
                    firstDiscovered.set('maxDate', dateStr);
                }
            });

            // Form submission handler (optional)
            $('#controlNotificationVulnForm').on('submit', function(e) {
                e.preventDefault();
                // Get form data
                var formData = $(this).serialize();
                $.ajaxSetup({
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    }
                });
                // AJAX request (replace with actual URL)
                $.ajax({
                    type: 'POST',
                    url: '{{ route('admin.vulnerability_management.vulnerabilitiesSendNotification.store') }}',
                    data: formData,
                    success: function(response) {
                        makeAlert('success', response.message, "{{ __('locale.Success') }}");
                        $('#controlNotificationVulnModal').modal('hide');
                    },
                    error: function(error) {
                        // Handle error response
                        makeAlert('error', 'An error occurred while exporting vulns.');
                    }
                });
            });
        });
        function showDescriptionInModal(description) {
            // Set the full description in the modal body
            $('#modalDescriptionContent').text(description);

            // Show the modal using jQuery
            $('#descriptionModal').modal('show');
        }
    </script>
@endsection
